{% extends "base.html" %}

{% block title %}Create Post - GroupMe Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-edit"></i> Create Post
        </h1>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-paper-plane"></i> Post Details
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="title" class="form-label">Post Title</label>
                                <input type="text" class="form-control" id="title" name="title" required 
                                       placeholder="e.g., Upcoming Event Announcement">
                                <div class="form-text">A title to help you identify this post.</div>
                            </div>

                            <div class="mb-3">
                                <label for="group_chat_id" class="form-label">Target Group</label>
                                <select class="form-select" id="group_chat_id" name="group_chat_id" required>
                                    <option value="">Select a group chat...</option>
                                    {% for group in group_chats %}
                                        <option value="{{ group.id }}">{{ group.name }}</option>
                                    {% endfor %}
                                </select>
                                {% if not group_chats %}
                                    <div class="form-text">
                                        <a href="{{ url_for('add_group') }}">Add a group chat first</a>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="message" class="form-label">Message</label>
                                <textarea class="form-control" id="message" name="message" rows="4" required 
                                          placeholder="Write your message here..."></textarea>
                                <div class="form-text">The message that will be sent to the group chat.</div>
                            </div>

                            <div class="mb-3">
                                <label for="links" class="form-label">Links (Optional)</label>
                                <textarea class="form-control" id="links" name="links" rows="2" 
                                          placeholder="https://example.com/event&#10;https://tickets.example.com"></textarea>
                                <div class="form-text">Enter one link per line. These will be added to your message.</div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Poster/Image (Optional)</label>
                                <div class="upload-area" onclick="document.getElementById('image').click()">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <p class="mb-2">Click to upload or drag and drop</p>
                                    <p class="text-muted small">PNG, JPG, GIF up to 16MB</p>
                                    <div class="file-name" style="display: none;"></div>
                                </div>
                                <input type="file" id="image" name="image" accept="image/*" style="display: none;">
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="send_immediately" name="send_immediately" checked>
                                    <label class="form-check-label" for="send_immediately">
                                        Send immediately
                                    </label>
                                </div>
                                <div class="form-text">If unchecked, you can schedule this post for later.</div>
                            </div>

                            <div class="mb-3" id="schedule-section" style="display: none;">
                                <label class="form-label">Schedule Options</label>
                                
                                <!-- Quick Schedule Buttons -->
                                <div class="mb-3">
                                    <label class="form-label small">Quick Schedule:</label>
                                    <div class="btn-group btn-group-sm w-100" role="group">
                                        <button type="button" class="btn quick-schedule-btn" onclick="setQuickTime(1)">1 Hour</button>
                                        <button type="button" class="btn quick-schedule-btn" onclick="setQuickTime(6)">6 Hours</button>
                                        <button type="button" class="btn quick-schedule-btn" onclick="setQuickTime(24)">1 Day</button>
                                        <button type="button" class="btn quick-schedule-btn" onclick="setQuickTime(168)">1 Week</button>
                                    </div>
                                </div>

                                <!-- Custom Date/Time -->
                                <div class="mb-3">
                                    <label for="scheduled_time" class="form-label">Custom Date & Time:</label>
                                    <input type="datetime-local" class="form-control" id="scheduled_time" name="scheduled_time">
                                </div>

                                <!-- Simple Recurring Options -->
                                <div class="mb-3">
                                    <label class="form-label">Repeat This Message:</label>
                                    
                                    <!-- Simple Recurring Buttons -->
                                    <div class="btn-group w-100 mb-3" role="group">
                                        <input type="radio" class="btn-check" name="repeat_type" id="no_repeat" value="none" checked>
                                        <label class="btn btn-outline-secondary" for="no_repeat">Once Only</label>
                                        
                                        <input type="radio" class="btn-check" name="repeat_type" id="daily_repeat" value="daily">
                                        <label class="btn btn-outline-primary" for="daily_repeat">Daily</label>
                                        
                                        <input type="radio" class="btn-check" name="repeat_type" id="weekly_repeat" value="weekly">
                                        <label class="btn btn-outline-primary" for="weekly_repeat">Weekly</label>
                                    </div>

                                    <!-- Daily Options -->
                                    <div class="mb-3" id="daily-options" style="display: none;">
                                        <div class="card border-primary">
                                            <div class="card-body">
                                                <h6 class="card-title">Daily Settings</h6>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label for="daily_time" class="form-label">Send at:</label>
                                                        <input type="time" class="form-control" id="daily_time" name="daily_time" value="09:00">
                                                    </div>
                                                    <div class="col-6">
                                                        <label for="daily_days" class="form-label">For how many days:</label>
                                                        <input type="number" class="form-control" id="daily_days" name="daily_days" value="7" min="1" max="30">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Weekly Options -->
                                    <div class="mb-3" id="weekly-options" style="display: none;">
                                        <div class="card border-success">
                                            <div class="card-body">
                                                <h6 class="card-title">Weekly Settings</h6>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label for="weekly_time" class="form-label">Send at:</label>
                                                        <input type="time" class="form-control" id="weekly_time" name="weekly_time" value="09:00">
                                                    </div>
                                                    <div class="col-6">
                                                        <label for="weekly_weeks" class="form-label">For how many weeks:</label>
                                                        <input type="number" class="form-control" id="weekly_weeks" name="weekly_weeks" value="4" min="1" max="12">
                                                    </div>
                                                </div>
                                                <div class="mt-2">
                                                    <label class="form-label">On which day:</label>
                                                    <select class="form-select" id="weekly_day" name="weekly_day">
                                                        <option value="monday">Monday</option>
                                                        <option value="tuesday">Tuesday</option>
                                                        <option value="wednesday">Wednesday</option>
                                                        <option value="thursday">Thursday</option>
                                                        <option value="friday">Friday</option>
                                                        <option value="saturday">Saturday</option>
                                                        <option value="sunday">Sunday</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Create Post
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="card mt-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-eye"></i> Message Preview
                </h5>
            </div>
            <div class="card-body">
                <div id="message-preview" class="border p-3 rounded bg-light">
                    <p class="text-muted">Your message will appear here as you type...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sendImmediatelyCheckbox = document.getElementById('send_immediately');
    const scheduleSection = document.getElementById('schedule-section');
    const messageTextarea = document.getElementById('message');
    const linksTextarea = document.getElementById('links');
    const previewDiv = document.getElementById('message-preview');

    // Initialize schedule section visibility
    function updateScheduleVisibility() {
        if (sendImmediatelyCheckbox.checked) {
            scheduleSection.style.display = 'none';
        } else {
            scheduleSection.style.display = 'block';
            // Set default time to 1 hour from now
            const now = new Date();
            now.setHours(now.getHours() + 1);
            document.getElementById('scheduled_time').value = now.toISOString().slice(0, 16);
        }
    }

    // Toggle schedule section
    sendImmediatelyCheckbox.addEventListener('change', updateScheduleVisibility);
    
    // Initialize on page load
    updateScheduleVisibility();

    // Toggle simple recurring options
    const repeatTypeRadios = document.querySelectorAll('input[name="repeat_type"]');
    const dailyOptions = document.getElementById('daily-options');
    const weeklyOptions = document.getElementById('weekly-options');
    
    function updateRecurringOptions() {
        const selectedType = document.querySelector('input[name="repeat_type"]:checked').value;
        
        // Hide all options first
        dailyOptions.style.display = 'none';
        weeklyOptions.style.display = 'none';
        
        // Show relevant options
        if (selectedType === 'daily') {
            dailyOptions.style.display = 'block';
        } else if (selectedType === 'weekly') {
            weeklyOptions.style.display = 'block';
        }
    }
    
    // Add event listeners to all radio buttons
    repeatTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateRecurringOptions);
    });
    
    // Initialize on page load
    updateRecurringOptions();

    // Quick time functions
    window.setQuickTime = function(hours) {
        const now = new Date();
        now.setHours(now.getHours() + hours);
        document.getElementById('scheduled_time').value = now.toISOString().slice(0, 16);
    };


    // Update preview
    function updatePreview() {
        let message = messageTextarea.value;
        const links = linksTextarea.value.trim();
        
        if (links) {
            const linkList = links.split('\n').filter(link => link.trim());
            if (linkList.length > 0) {
                message += '\n\nLinks:';
                linkList.forEach(link => {
                    message += `\n${link.trim()}`;
                });
            }
        }
        
        if (message.trim()) {
            previewDiv.innerHTML = message.replace(/\n/g, '<br>');
        } else {
            previewDiv.innerHTML = '<p class="text-muted">Your message will appear here as you type...</p>';
        }
    }

    messageTextarea.addEventListener('input', updatePreview);
    linksTextarea.addEventListener('input', updatePreview);

    // File upload preview
    const fileInput = document.getElementById('image');
    const uploadArea = document.querySelector('.upload-area');
    const fileName = document.querySelector('.file-name');

    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            fileName.textContent = file.name;
            fileName.style.display = 'block';
            
            // Show image preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.createElement('img');
                preview.src = e.target.result;
                preview.style.maxWidth = '100%';
                preview.style.maxHeight = '200px';
                preview.style.marginTop = '10px';
                preview.style.borderRadius = '5px';
                
                // Remove existing preview
                const existingPreview = uploadArea.querySelector('img');
                if (existingPreview) {
                    existingPreview.remove();
                }
                
                uploadArea.appendChild(preview);
            };
            reader.readAsDataURL(file);
        }
    });
});
</script>
{% endblock %}
