{% extends "base.html" %}

{% block title %}Create Post - GroupMe Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-edit"></i> Create Post
        </h1>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-paper-plane"></i> Post Details
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="title" class="form-label">Post Title</label>
                                <input type="text" class="form-control" id="title" name="title" required 
                                       placeholder="e.g., Upcoming Event Announcement">
                                <div class="form-text">A title to help you identify this post.</div>
                            </div>

                            <div class="mb-3">
                                <label for="group_chat_id" class="form-label">Target Group</label>
                                <select class="form-select" id="group_chat_id" name="group_chat_id" required>
                                    <option value="">Select a group chat...</option>
                                    {% for group in group_chats %}
                                        <option value="{{ group.id }}">{{ group.name }}</option>
                                    {% endfor %}
                                </select>
                                {% if not group_chats %}
                                    <div class="form-text">
                                        <a href="{{ url_for('add_group') }}">Add a group chat first</a>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="message" class="form-label">Message</label>
                                <textarea class="form-control" id="message" name="message" rows="4" required 
                                          placeholder="Write your message here..."></textarea>
                                <div class="form-text">The message that will be sent to the group chat.</div>
                            </div>

                            <div class="mb-3">
                                <label for="links" class="form-label">Links (Optional)</label>
                                <textarea class="form-control" id="links" name="links" rows="2" 
                                          placeholder="https://example.com/event&#10;https://tickets.example.com"></textarea>
                                <div class="form-text">Enter one link per line. These will be added to your message.</div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Poster/Image (Optional)</label>
                                <div class="upload-area" onclick="document.getElementById('image').click()">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <p class="mb-2">Click to upload or drag and drop</p>
                                    <p class="text-muted small">PNG, JPG, GIF up to 16MB</p>
                                    <div class="file-name" style="display: none;"></div>
                                </div>
                                <input type="file" id="image" name="image" accept="image/*" style="display: none;">
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="send_immediately" name="send_immediately">
                                    <label class="form-check-label" for="send_immediately">
                                        Send immediately
                                    </label>
                                </div>
                                <div class="form-text">If unchecked, you can schedule this post for later.</div>
                            </div>

                            <div class="mb-3" id="schedule-section" style="display: none;">
                                <label class="form-label">Schedule Options</label>
                                
                                <!-- Quick Schedule Buttons -->
                                <div class="mb-3">
                                    <label class="form-label small">Quick Schedule:</label>
                                    <div class="btn-group btn-group-sm w-100" role="group">
                                        <button type="button" class="btn quick-schedule-btn" onclick="setQuickTime(1)">1 Hour</button>
                                        <button type="button" class="btn quick-schedule-btn" onclick="setQuickTime(6)">6 Hours</button>
                                        <button type="button" class="btn quick-schedule-btn" onclick="setQuickTime(24)">1 Day</button>
                                        <button type="button" class="btn quick-schedule-btn" onclick="setQuickTime(168)">1 Week</button>
                                    </div>
                                </div>

                                <!-- Custom Date/Time -->
                                <div class="mb-3">
                                    <label for="scheduled_time" class="form-label">Custom Date & Time:</label>
                                    <input type="datetime-local" class="form-control" id="scheduled_time" name="scheduled_time">
                                </div>

                                <!-- Daily Messages Section -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="daily_messages" name="daily_messages">
                                        <label class="form-check-label" for="daily_messages">
                                            <strong>ðŸ“… Daily Messages</strong> - Send this message every day at specific times
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3" id="daily-messages-section" style="display: none;">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="fas fa-calendar-day"></i> Daily Message Settings</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label for="daily_morning_time" class="form-label">Morning Time:</label>
                                                    <input type="time" class="form-control" id="daily_morning_time" name="daily_morning_time" value="09:00">
                                                    <small class="text-muted">Daily morning message time</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="daily_evening_time" class="form-label">Evening Time:</label>
                                                    <input type="time" class="form-control" id="daily_evening_time" name="daily_evening_time" value="18:00">
                                                    <small class="text-muted">Daily evening message time</small>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-md-6">
                                                    <label for="daily_start_date" class="form-label">Start Date:</label>
                                                    <input type="date" class="form-control" id="daily_start_date" name="daily_start_date">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="daily_end_date" class="form-label">End Date (Optional):</label>
                                                    <input type="date" class="form-control" id="daily_end_date" name="daily_end_date">
                                                    <small class="text-muted">Leave empty for no end date</small>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="daily_morning_only" name="daily_morning_only">
                                                    <label class="form-check-label" for="daily_morning_only">
                                                        Send only in the morning
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="daily_evening_only" name="daily_evening_only">
                                                    <label class="form-check-label" for="daily_evening_only">
                                                        Send only in the evening
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recurring Options -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="recurring" name="recurring">
                                        <label class="form-check-label" for="recurring">
                                            <strong>ðŸ”„ Advanced Recurring</strong> - Custom recurring schedule
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3" id="recurring-options" style="display: none;">
                                    <label class="form-label">Recurring Schedule:</label>
                                    
                                    <!-- Quick Recurring Options -->
                                    <div class="mb-3">
                                        <label class="form-label small">Quick Recurring:</label>
                                        <div class="btn-group btn-group-sm w-100" role="group">
                                            <button type="button" class="btn quick-schedule-btn" onclick="setRecurring('daily')">Daily</button>
                                            <button type="button" class="btn quick-schedule-btn" onclick="setRecurring('weekly')">Weekly</button>
                                            <button type="button" class="btn quick-schedule-btn" onclick="setRecurring('monthly')">Monthly</button>
                                        </div>
                                    </div>

                                    <!-- Custom Recurring -->
                                    <div class="mb-3">
                                        <label for="recurring_interval" class="form-label">Custom Repeat:</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="number" class="form-control" id="recurring_interval" name="recurring_interval" min="1" value="1">
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select" id="recurring_unit" name="recurring_unit">
                                                    <option value="hours">Hours</option>
                                                    <option value="days" selected>Days</option>
                                                    <option value="weeks">Weeks</option>
                                                    <option value="months">Months</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Specific Times for Daily -->
                                    <div class="mb-3" id="daily-times" style="display: none;">
                                        <label class="form-label">Send at specific times:</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="time" class="form-control" id="morning_time" name="morning_time" value="09:00">
                                                <small class="text-muted">Morning</small>
                                            </div>
                                            <div class="col-6">
                                                <input type="time" class="form-control" id="evening_time" name="evening_time" value="18:00">
                                                <small class="text-muted">Evening</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Days of Week for Weekly -->
                                    <div class="mb-3" id="weekly-days" style="display: none;">
                                        <label class="form-label">Repeat on days:</label>
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="btn-group btn-group-sm w-100" role="group">
                                                    <input type="checkbox" class="btn-check" id="mon" name="weekdays" value="monday">
                                                    <label class="btn btn-outline-secondary" for="mon">Mon</label>
                                                    
                                                    <input type="checkbox" class="btn-check" id="tue" name="weekdays" value="tuesday">
                                                    <label class="btn btn-outline-secondary" for="tue">Tue</label>
                                                    
                                                    <input type="checkbox" class="btn-check" id="wed" name="weekdays" value="wednesday">
                                                    <label class="btn btn-outline-secondary" for="wed">Wed</label>
                                                    
                                                    <input type="checkbox" class="btn-check" id="thu" name="weekdays" value="thursday">
                                                    <label class="btn btn-outline-secondary" for="thu">Thu</label>
                                                    
                                                    <input type="checkbox" class="btn-check" id="fri" name="weekdays" value="friday">
                                                    <label class="btn btn-outline-secondary" for="fri">Fri</label>
                                                    
                                                    <input type="checkbox" class="btn-check" id="sat" name="weekdays" value="saturday">
                                                    <label class="btn btn-outline-secondary" for="sat">Sat</label>
                                                    
                                                    <input type="checkbox" class="btn-check" id="sun" name="weekdays" value="sunday">
                                                    <label class="btn btn-outline-secondary" for="sun">Sun</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-text">This will create multiple scheduled posts automatically.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Create Post
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="card mt-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-eye"></i> Message Preview
                </h5>
            </div>
            <div class="card-body">
                <div id="message-preview" class="border p-3 rounded bg-light">
                    <p class="text-muted">Your message will appear here as you type...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sendImmediatelyCheckbox = document.getElementById('send_immediately');
    const scheduleSection = document.getElementById('schedule-section');
    const messageTextarea = document.getElementById('message');
    const linksTextarea = document.getElementById('links');
    const previewDiv = document.getElementById('message-preview');

    // Toggle schedule section
    sendImmediatelyCheckbox.addEventListener('change', function() {
        if (this.checked) {
            scheduleSection.style.display = 'none';
        } else {
            scheduleSection.style.display = 'block';
            // Set default time to 1 hour from now
            const now = new Date();
            now.setHours(now.getHours() + 1);
            document.getElementById('scheduled_time').value = now.toISOString().slice(0, 16);
        }
    });

    // Toggle daily messages section
    const dailyMessagesCheckbox = document.getElementById('daily_messages');
    const dailyMessagesSection = document.getElementById('daily-messages-section');
    
    if (dailyMessagesCheckbox) {
        dailyMessagesCheckbox.addEventListener('change', function() {
            if (this.checked) {
                dailyMessagesSection.style.display = 'block';
                // Set default start date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('daily_start_date').value = today;
            } else {
                dailyMessagesSection.style.display = 'none';
            }
        });
    }

    // Toggle recurring options
    const recurringCheckbox = document.getElementById('recurring');
    const recurringOptions = document.getElementById('recurring-options');
    
    if (recurringCheckbox) {
        recurringCheckbox.addEventListener('change', function() {
            if (this.checked) {
                recurringOptions.style.display = 'block';
            } else {
                recurringOptions.style.display = 'none';
            }
        });
    }

    // Quick time functions
    window.setQuickTime = function(hours) {
        const now = new Date();
        now.setHours(now.getHours() + hours);
        document.getElementById('scheduled_time').value = now.toISOString().slice(0, 16);
    };

    // Recurring functions
    window.setRecurring = function(type) {
        const recurringCheckbox = document.getElementById('recurring');
        const dailyTimes = document.getElementById('daily-times');
        const weeklyDays = document.getElementById('weekly-days');
        const recurringUnit = document.getElementById('recurring_unit');
        const recurringInterval = document.getElementById('recurring_interval');
        
        // Check the recurring checkbox
        recurringCheckbox.checked = true;
        recurringOptions.style.display = 'block';
        
        // Hide all specific options first
        dailyTimes.style.display = 'none';
        weeklyDays.style.display = 'none';
        
        if (type === 'daily') {
            recurringUnit.value = 'days';
            recurringInterval.value = '1';
            dailyTimes.style.display = 'block';
        } else if (type === 'weekly') {
            recurringUnit.value = 'weeks';
            recurringInterval.value = '1';
            weeklyDays.style.display = 'block';
        } else if (type === 'monthly') {
            recurringUnit.value = 'months';
            recurringInterval.value = '1';
        }
    };

    // Update preview
    function updatePreview() {
        let message = messageTextarea.value;
        const links = linksTextarea.value.trim();
        
        if (links) {
            const linkList = links.split('\n').filter(link => link.trim());
            if (linkList.length > 0) {
                message += '\n\nLinks:';
                linkList.forEach(link => {
                    message += `\n${link.trim()}`;
                });
            }
        }
        
        if (message.trim()) {
            previewDiv.innerHTML = message.replace(/\n/g, '<br>');
        } else {
            previewDiv.innerHTML = '<p class="text-muted">Your message will appear here as you type...</p>';
        }
    }

    messageTextarea.addEventListener('input', updatePreview);
    linksTextarea.addEventListener('input', updatePreview);

    // File upload preview
    const fileInput = document.getElementById('image');
    const uploadArea = document.querySelector('.upload-area');
    const fileName = document.querySelector('.file-name');

    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            fileName.textContent = file.name;
            fileName.style.display = 'block';
            
            // Show image preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.createElement('img');
                preview.src = e.target.result;
                preview.style.maxWidth = '100%';
                preview.style.maxHeight = '200px';
                preview.style.marginTop = '10px';
                preview.style.borderRadius = '5px';
                
                // Remove existing preview
                const existingPreview = uploadArea.querySelector('img');
                if (existingPreview) {
                    existingPreview.remove();
                }
                
                uploadArea.appendChild(preview);
            };
            reader.readAsDataURL(file);
        }
    });
});
</script>
{% endblock %}
